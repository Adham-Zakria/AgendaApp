@model IEnumerable<DataAccessLayer.Models.Transaction>

@{
    ViewData["Title"] = "لوحة المدير";
}

<div class="container mt-4" dir="rtl">
    <h3 class="mb-4 text-center">لوحة مراجعة المعاملات</h3>

    <form method="get" class="row mb-4">
        <div class="col-md-3">
            <label>من تاريخ</label>
            <input type="date" name="fromDate" class="form-control" />
        </div>

        <div class="col-md-3">
            <label>إلى تاريخ</label>
            <input type="date" name="toDate" class="form-control" />
        </div>

        <div class="col-md-3">
            <label>الفرع</label>
            <select name="branchId" class="form-select">
                <option value="">الكل</option>
                @foreach (var branch in ViewBag.Branches)
                {
                    <option value="@branch.BranchId"> @branch.BranchName </option> 
                }
            </select>
        </div>

        <div class="col-md-3">
            <label>الموظف</label>
            <select name="userId" class="form-select">
                <option value="">الكل</option>
                @foreach (var user in ViewBag.Users)
                {
                    @if(user.GroupId == 2)
                    {
                        <option value="@user.UserId"> @user.UserId - @user.UserName </option> 
                    }
                }
            </select>
        </div>

        <div class="col-md-12 mt-3 text-center">
            <button type="submit" class="btn btn-outline-primary">فلترة</button>
              @{
                var fromDate = Context.Request.Query["fromDate"].ToString();
                var toDate = Context.Request.Query["toDate"].ToString();
                var branchId = Context.Request.Query["branchId"].ToString();
                var userId = Context.Request.Query["userId"].ToString();
            }  

            <a href="@Url.Action("ExportToExcel", new { fromDate = fromDate, toDate = toDate, branchId = branchId, userId = userId })"
               class="btn btn-outline-success ms-2">
                تصدير إلى Excel
            </a>

            <a href="@Url.Action("Print", new { fromDate = fromDate, toDate = toDate, branchId = branchId, userId = userId })"
               target="_blank"
               class="btn btn-outline-dark ms-2">
                طباعة
            </a>


        </div>
    </form>

    <div class="d-flex justify-content-between align-items-center mb-4" dir="rtl">
        <h3 class="mb-0">لوحة المدير</h3>

        <div class="d-flex gap-2">
            <a href="/Users/Add" class="btn btn-secondary">
                <i class="bi bi-person-plus"></i> إضافة موظف جديد
            </a>
            <a href="/ManagerDashboard/BranchClosings" class="btn btn-secondary">
                <i class="bi bi-calendar-check"></i> عرض تقفيلات الفروع
            </a>
        </div>
    </div>



       @* <table class="table table-bordered table-striped text-center">
           <thead class="table-dark">
               <tr>
                   <th>التاريخ</th>
                   <th>الفرع</th>
                   <th>الموظف</th>
                   <th>كود الموظف</th>
                   <th>النوع</th>
                   <th>الوصف</th>
                   <th>البيان</th> 
                   <th>المبلغ</th>
                   <th>تعديل</th>
       
               </tr>
           </thead>
           <tbody>
               @foreach (var t in Model)
               {
                   <tr>
                       <td>@t.TransactionDate</td>
                       <td>@t.Branch?.BranchName</td>
                       <td>@t.User?.UserName</td>
                       <td>@t.User?.UserId</td>
                       <td>@t.Type</td>
                       <td>@t.Description</td>
                       <td>@(t.Category ?? "-")</td>
                       <td>@t.Amount</td>
                       <td>
                           <button class="btn btn-sm btn-outline-primary edit-btn" data-id="@t.TransactionId">تعديل</button>
                           <div class="mt-1 small text-muted" id="modify-info-@t.TransactionId">
                               @if (t.LastModifiedBy != null)
                               {
                                   <span>آخر تعديل بواسطة: <b>@t.LastModifiedBy</b></span>
                           
                                   <br />
                                   <span>@t.LastModifiedAt?.ToString("yyyy-MM-dd HH:mm")</span>
                               }
                           </div>
                       </td>
       
                   </tr>
               }
           </tbody>
       </table> *@
    <div style="max-height: 400px; overflow-y: auto;">
        <table class="table table-bordered table-striped text-center mb-0">
            <thead class="table-dark sticky-top">
                <tr>
                    <th>التاريخ</th>
                    <th>الفرع</th>
                    <th>الموظف</th>
                    <th>كود الموظف</th>
                    <th>النوع</th>
                    <th>الوصف</th>
                    <th>البيان</th>
                    <th>المبلغ</th>
                    <th>تعديل</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var t in Model)
                {
                    <tr>
                        <td>@t.TransactionDate</td>
                        <td>@t.Branch?.BranchName</td>
                        <td>@t.User?.UserName</td>
                        <td>@t.User?.UserId</td>
                        <td>@t.Type</td>
                        <td>@t.Description</td>
                        <td>@(t.Category ?? "-")</td>
                        <td>@t.Amount</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-btn" data-id="@t.TransactionId">تعديل</button>

                            <div class="mt-1 small text-muted" id="modify-info-@t.TransactionId">
                                @if (t.LastModifiedBy != null)
                                {
                                    <span>آخر تعديل بواسطة: <b>@t.LastModifiedBy</b></span>
                                    <br />
                                    <span>@t.LastModifiedAt?.ToString("yyyy-MM-dd HH:mm")</span>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <hr class="my-4" />

    <h4 class="text-center mb-3">معلومات الكاشير و مسئولي الفرع</h4>

    <div style="max-height: 300px; overflow-y: auto;">
        <table class="table table-bordered table-striped text-center mb-0">
            <thead class="table-dark sticky-top">
                <tr>
                    <th>التاريخ</th>
                    <th>الفرع</th>
                    <th>الوظيفة</th>
                    <th>الاسم</th>
                    <th>الكود</th>
                    <th>القيمة</th>
                    <th>ملاحظات عامة</th>
                    <th>تعديل</th>
                </tr>
            </thead>

            <tbody>
                @if (ViewBag.AdditionalInfo != null && ViewBag.AdditionalInfo.Count > 0)
                {
                    foreach (var info in ViewBag.AdditionalInfo)
                    {
                        <tr>
                            <td>@info.TransactionDate</td>
                            <td>@info.Branch?.BranchName</td>
                            <td>@info.Position</td>
                            <td>@info.FullName</td>
                            <td>@info.Code</td>

                            <td style="color:@(info.Value < 0 ? "red" : info.Value > 0 ? "green" : "black"); font-weight:bold;">
                                   @(info.Value ?? 0)
                            </td>

                            <td>@(info.Notes ?? "-")</td>

                            <td>
                                <button class="btn btn-sm btn-outline-primary edit-info-btn"
                                        data-id="@info.InfoId">
                                    تعديل
                                </button>
                                <div class="mt-1 small text-muted" id="modify-info-@info.InfoId">
                                    @if (info.LastModifiedBy != null)
                                    {
                                        <span>آخر تعديل بواسطة: <b>@info.LastModifiedBy</b></span>
                                        <br />
                                        <span>@info.LastModifiedAt?.ToString("yyyy-MM-dd HH:mm")</span>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7" class="text-danger">لا توجد معلومات لهذا اليوم.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>



    <!-- Modal placeholder -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" id="editModalContent"></div>
        </div>
    </div>
    <div class="modal fade" id="editAdditionalModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" id="editAdditionalModalContent"></div>
        </div>
    </div>



    @section Scripts {
        <script>
            $(document).on("click", ".edit-btn", function () {
                var id = $(this).data("id");
                $.get("/ManagerDashboard/Edit/" + id, function (html) {
                    $("#editModalContent").html(html);
                    $("#editModal").modal("show");
                });
            });

            $(document).on("click", "#saveEditBtn", function () {
                var formData = $("#editTransactionForm").serialize();
                $.post("/ManagerDashboard/Edit", formData, function (res) {
                    if (res.success) {
                        $("#editModal").modal("hide");
                        location.reload();
                    } else {
                        alert("حدث خطأ أثناء الحفظ");
                    }
                });
            });

            $(document).on("click", ".edit-info-btn", function () {
                var id = $(this).data("id");

                $.get("/AdditionalInfo/Edit/" + id, function (html) {
                    $("#editAdditionalModalContent").html(html);
                    $("#editAdditionalModal").modal("show");
                });
            });

            $(document).on("click", "#saveAdditionalInfoBtn", function () {
                var formData = $("#editAdditionalInfoForm").serialize();

                $.post("/AdditionalInfo/Edit", formData, function (res) {
                    if (res.success) {
                        $("#editAdditionalModal").modal("hide");
                        location.reload();
                    } else {
                        alert("خطأ أثناء التعديل");
                    }
                });
            });

        </script>
    }

</div>



