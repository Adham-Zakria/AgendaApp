@model IEnumerable<DataAccessLayer.Models.Transaction>

@{
    Layout = null;   // print without main layout
    // var today = DateTime.Now.ToString("dddd dd/MM/yyyy");
    var fromDateText = ViewBag.FromDateText;
    var toDateText = ViewBag.ToDateText;
    var branchName = ViewBag.BranchName;
    // var addInfo = ViewBag.AdditionalInfo as IEnumerable<DataAccessLayer.Models.AdditionalInfo>;
    var addInfo = (ViewBag.AdditionalInfo as IEnumerable<DataAccessLayer.Models.AdditionalInfo>)
              ?? Enumerable.Empty<DataAccessLayer.Models.AdditionalInfo>();

}

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>طباعة تقرير اليوم</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        body {
            font-family: 'Tahoma', sans-serif;
            padding: 20px;
        }

        @@media print {

            .no-print {
                display: none !important;
            }

            body {
                margin: 0;
                padding: 0;
            }
        }
    </style>
</head>

<body>

    <!-- زر العودة (لن يظهر في الطباعة) -->
    <div class="text-center mb-3 no-print">
        <a href="/ManagerDashboard/Index" class="btn btn-secondary"> ← العودة للوحة المدير </a>
    </div>

    <h3 class="text-center mb-4 fw-bold">تقرير المعاملات اليومية</h3>

    <div class="alert alert-secondary fs-5 text-center mb-4">
        <strong>الفرع:</strong> @branchName 
        @* <strong>تاريخ اليوم:</strong> @Date *@
        <p>
            <strong>الفترة: من</strong>
            @fromDateText
            <strong>إلى</strong>
            @toDateText
        </p>

    </div>

    <!-- جدول المعاملات -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">

            <div class="alert alert-info text-center fs-5">
                <strong>رصيد البداية:</strong> @ViewBag.OpeningBalance.ToString("N2") جنية
            </div>

            <table class="table table-bordered text-center align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>الإيرادات</th>
                        <th>المصروفات</th>
                        <th>النوع</th>
                        <th>الوصف</th>
                        <th>البيان</th>
                    </tr>
                </thead>

                <tbody>
                    @{
                        decimal totalIncome = 0;
                        decimal totalExpense = 0;

                        decimal bankPayment = 0;
                        decimal wholesalePayment = 0;
                        decimal visaPayment = 0;
                        decimal ownerPayment = 0;
                    }

                    @foreach (var t in Model)
                    {
                        switch (t.Type)
                        {
                            case "إيراد": 
                                totalIncome += (decimal)t.Amount; 
                                break;

                            case "مصروف": 
                                totalExpense += (decimal)t.Amount;
                                break;

                            case "دفعة بنك":
                                bankPayment += (decimal)t.Amount;
                                break;

                            case "دفعة جملة ماركت": 
                                wholesalePayment += (decimal)t.Amount;
                                break;

                            case "فيزا بنك":
                                visaPayment += (decimal)t.Amount;
                                break;

                            case "جاري مالك":
                                ownerPayment += (decimal)t.Amount;
                                break;
                        }

                        if (t.Type == "إيراد" || t.Type == "مصروف")
                        {
                            <tr>
                                <td>@(t.Type == "إيراد" ? t.Amount : "-")</td>
                                <td>@(t.Type == "مصروف" ? t.Amount : "-")</td>
                                <td>@t.Type</td>
                                <td>@t.Description</td>
                                <td>@(t.Category ?? "-")</td>
                            </tr>
                        }
                    }

                    @{
                        decimal openingBalance = ViewBag.OpeningBalance ?? 0;
                        decimal currentBalance = (totalIncome - totalExpense) + openingBalance;
                        decimal closingBalance = currentBalance - (bankPayment + wholesalePayment + visaPayment + ownerPayment);
                    }

                    <!-- إجماليات -->
                    <tr class="fw-bold table-secondary">
                        <td colspan="3">إجمالي الإيرادات</td>
                        <td colspan="2">@totalIncome.ToString("N2")</td>
                    </tr>

                    <tr class="fw-bold table-secondary">
                        <td colspan="3">إجمالي المصروفات</td>
                        <td colspan="2">@totalExpense.ToString("N2")</td>
                    </tr>

                    <tr class="fw-bold table-info">
                        <td colspan="3">الرصيد</td>
                        <td colspan="2">@currentBalance.ToString("N2")</td>
                    </tr>

                    <tr class="fw-bold table-light">
                        <td colspan="3">دفعة بنك</td>
                        <td colspan="2">@bankPayment.ToString("N2")</td>
                    </tr>

                    <tr class="fw-bold table-light">
                        <td colspan="3">دفعة جملة ماركت</td>
                        <td colspan="2">@wholesalePayment.ToString("N2")</td>
                    </tr>

                    <tr class="fw-bold table-light">
                        <td colspan="3">فيزا بنك</td>
                        <td colspan="2">@visaPayment.ToString("N2")</td>
                    </tr>

                    <tr class="fw-bold table-light">
                        <td colspan="3">جاري مالك</td>
                        <td colspan="2">@ownerPayment.ToString("N2")</td>
                    </tr>

                    <tr class="fw-bold table-info">
                        <td colspan="3">الرصيد المرحل</td>
                        <td colspan="2">@closingBalance.ToString("N2")</td>
                    </tr>

                </tbody>
            </table>
        </div>
    </div>

    <!-- جدول معلومات الكاشير ومسئولي الفرع -->
    <div class="card shadow-sm">
        <div class="card-body">

            <h4 class="text-center mb-3 fw-bold">معلومات الكاشير و مسئولي الفرع</h4>

            @if (addInfo != null && addInfo.Any())
            {
                <table class="table table-bordered text-center align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>الوظيفة</th>
                            <th>الاسم</th>
                            <th>الكود</th>
                            <th>القيمة</th>
                            <th>ملاحظات</th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var info in addInfo)
                        {
                            var value = info.Value ?? 0;
                            var valueColor = value > 0 ? "green" : value < 0 ? "red" : "black";

                            <tr>
                                <td>@info.Position</td>
                                <td>@info.FullName</td>
                                <td>@info.Code</td>
                                <td style="color:@valueColor; font-weight:bold;">@value</td>
                                <td>@(info.Notes ?? "-")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div class="alert alert-info text-center">لا توجد معلومات لهذا اليوم.</div>
            }

        </div>
    </div>

    <!-- طباعة تلقائية -->
    <script>
        window.onload = function () {
            window.print();
        };
    </script>

</body>
</html>
